<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" >
<!-- <head> 공통   -->
<head th:replace="~{common/frame_head :: head('고객사 및 고객 관리')}"></head>
<body>
<div class="wrapper">
    <!-- 왼쪽 메뉴  -->
    <div th:replace="~{common/frame_left_menu :: frame_left_menu}" />
    <!-- 상단 메뉴  -->
    <div th:replace="~{common/frame_top_menu :: frame_top_menu}" />

    <!-- 컨텐츠 영역 -->
    <div class="main-area">
        <!-- 내용 영역 -->
        <main class="form-content">
            <div class="container">
                <div class="orReport-widget-wrap">
                    <div class="content">
                        <!-- 검색 영역 -->
                        <div class="search--box">
                            <div class="content-header">
                                <h2 class="text-body1">
                                    <div class="flex flex-align_center gap--8">
                                        <b>고객사/고객 관리 페이지</b>
                                    </div>
                                </h2>
                                <!-- 검색영역 -->
                                <div class="searchbar">
                                    <div>
                                        <div class="dropdown dropdown--s wd120" aria-expanded="false" tabindex="0">
                                            <select class="dropdown__selected" id="clientType" onchange="generateList(this)">
                                                <option value="COMPANY" selected>고객사 관리</option>
                                                <option value="CLIENT">고객 관리</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- 고객사 상세 검색 div -->
                                    <div id="srch_Company" style="display: none;">
                                        <div class="search-wrap">
                                            <input type="text" id="searchCompany" name="searchCompany"
                                                   class="input--s input01" placeholder="회사명을 입력해주세요."
                                                   th:value="${searchCompany}"
                                                   onkeydown="if (event.keyCode === 13) searchCompany(this);">
                                            <button class="icon-btn search__btn" onclick="searchCompany(this);">
                                                <svg class="icon"><use th:href="@{/assets/images/icon/sprite-sheet.svg#search}"/></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div style="align-content: center;">
                                        <button class="btn just-icon btn--24" onclick="searchCompany(this);" id="refresh1" style="display: none;">
                                            <svg class="icon"><use th:href="@{/assets/images/icon/sprite-sheet.svg#refresh}"/></svg>
                                        </button>
                                    </div>
                                    <!-- 고객 상세 검색 div -->
                                    <div id="srchClient_id" style="display: none;">
                                        <div class="search-wrap">
                                            <input type="text" id="srch_client_id" name="srch_client_id"
                                                   class="input--s input01" placeholder="사용자 아이디를 입력해주세요."
                                                   th:value="${userId}"
                                                   onkeydown="if (event.keyCode === 13) searchClient(this);">
                                            <button class="icon-btn search__btn" onclick="searchClient(this);">
                                                <svg class="icon"><use th:href="@{/assets/images/icon/sprite-sheet.svg#search}"/></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="srchClient_nm" style="display: none;">
                                        <div class="search-wrap">
                                            <input type="text" id="srch_client_nm" name="srch_client_nm"
                                                   class="input--s input01" placeholder="사용자 이름을 입력해주세요."
                                                   th:value="${userName}"
                                                   onkeydown="if (event.keyCode === 13) searchClient(this);">
                                            <button class="icon-btn search__btn" onclick="searchClient(this);">
                                                <svg class="icon"><use th:href="@{/assets/images/icon/sprite-sheet.svg#search}"/></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="srchClient_company" style="display: none;">
                                        <div class="search-wrap">
                                            <input type="text" id="srch_client_company" name="srch_client_company"
                                                   class="input--s input01" placeholder="회사명을 입력해주세요."
                                                   th:value="${companyName}"
                                                   onkeydown="if (event.keyCode === 13) searchClient(this);">
                                            <button class="icon-btn search__btn" onclick="searchClient(this);">
                                                <svg class="icon"><use th:href="@{/assets/images/icon/sprite-sheet.svg#search}"/></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div style="align-content: center;">
                                        <button class="btn just-icon btn--24" onclick="searchClient(this);" id="refresh2" style="display: none;">
                                            <svg class="icon"><use th:href="@{/assets/images/icon/sprite-sheet.svg#refresh}"/></svg>
                                        </button>
                                    </div>
                                    <!-- // 상세검색 영역 -->
                                </div>
                                <!-- //검색영역 -->
                            </div>
                        </div>

                        <!-- 리스트 영역 -->
                        <div class="flex-container">
                            <!-- 고객사 목록 -->
                            <div class="flex1 widget-list" id="companyList" style="display: none; display: flex; flex-direction: column; min-height: 100%; justify-content: space-between;">
                                <section class="clientList-parts">
                                    <div class="widget__content">
                                        <div class="client_button">
                                            <button type="button" class="btn btn--s primary-btn" onclick="createCompanyModal()">고객사 등록</button>
                                        </div>
                                        <div class="is_full">
                                            <div class="board-list board--m list-wrap ">
                                                <table class="table table01 table-ellipsis">
                                                    <colgroup>
                                                        <col style="width: 25%;">
                                                        <col style="width: 75%;">
                                                    </colgroup>
                                                    <thead>
                                                    <tr>
                                                        <th>고객사 아이디</th>
                                                        <th>고객사 명</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody id="companyBody">
                                                        <tr th:if="${companyList == null or #lists.isEmpty(companyList)}">
                                                            <td colspan="2" style="text-align:center;">내역이 없습니다</td>
                                                        </tr>
                                                        <tr th:each="item : ${companyList.dataList}" class="click-row" th:attr="data-id=${item['COMPANY_ID']}" >
                                                            <td><span th:text="${item['COMPANY_ID']}"></span></td>
                                                            <td><span th:text="${item['COMPANY_NAME']}"></span></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 페이징 버튼 템플릿 -->
                                    <div class="client-footer">
                                        <div th:replace="~{fragments/pagination :: pagination(${companyList}, 'companyList')}"/>
                                    </div>
                                    <input type="hidden" id ="currentPage"  th:field="${companyList.currentPage}" readonly>
                                    <!-- //페이징 버튼 템플릿 -->
                                </section>
                            </div>
                            <!-- 고객 목록 -->
                            <div class="flex1 widget-list" id="clientList" style="display: none;">
                                <section class="clientList-parts2">
                                    <div class="widget__content">
                                        <div class="client_button">
                                            <button type="button" class="btn btn--s primary-btn">고객 등록</button>
                                        </div>
                                        <div class="is_full">
                                            <div class="board-list board--m list-wrap ">
                                                <table class="table table01 table-ellipsis">
                                                    <colgroup>
                                                        <col style="width: 30%;">
                                                        <col style="width: 40%;">
                                                        <col style="width: 30%;">
                                                    </colgroup>
                                                    <thead>
                                                    <tr>
                                                        <th>고객 명</th>
                                                        <th>회사 명</th>
                                                        <th>고객 권한</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody id="clientBody">
                                                        <!-- 데이터가 동적으로 추가될 영역 -->
                                                        <tr>
                                                            <td colspan="4" style="text-align:center;">내역이 없습니다</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 페이징 버튼 템플릿 -->
                                    <div class="client-footer2"></div>
                                    <!-- //페이징 버튼 템플릿 -->
                                </section>
                            </div>


                            <!-- 고객사 상세 -->
                            <div class="flex1 widget-detail" id="companyDetailView" style="display: none;">
                                <section class="clientList-parts">
                                    <div class="widget__content"  id="companyDetail">
                                        <div class="content-header">
                                            <h2 class="text-body1">
                                                <div class="flex flex-align_center gap--8">
                                                    <b>고객사 상세</b>
                                                </div>
                                            </h2>
                                        </div>
                                        <table class="table table03 table--h table--xs">
                                            <colgroup>
                                                <col style="width: 18%;">
                                                <col style="width: 32%;">
                                                <col style="width: 18%;">
                                            </colgroup>
                                            <tbody>
                                                <tr>
                                                    <th>회사코드</th>
                                                    <td colspan="2">
                                                        <span id="companyId" th:each="detail : ${companyDetail}" th:text="${detail.companyId}"></span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>회사명</th>
                                                    <td colspan="2">
                                                        <span id="companyName" th:each="detail : ${companyDetail}" th:text="${detail.companyName}"></span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>담당자(PM)</th>
                                                    <td colspan="2">
                                                        <span id="managerId" th:each="detail : ${companyDetail}" th:text="${detail.managerId}"></span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            </div>
                            <!-- 고객 상세 -->
                            <div class="flex1 widget-detail" id="clientDetailView" style="display: none;">
                                <section class="clientList-parts2">
                                    <div class="widget__content"  id="clientDetail">
                                        <div class="content-header">
                                            <h2 class="text-body1">
                                                <div class="flex flex-align_center gap--8">
                                                    <b>고객 상세</b>
                                                </div>
                                            </h2>
                                        </div>
                                        <table class="table table03 table--h table--xs">
                                            <colgroup>
                                                <col style="width: 18%;">
                                                <col style="width: 32%;">
                                                <col style="width: 18%;">
                                            </colgroup>
                                            <tbody>
                                                <tr>
                                                    <th>아이디</th>
                                                    <td colspan="2"><span id="userId"></span></td>
                                                </tr>
                                                <tr>
                                                    <th>사원명</th>
                                                    <td colspan="2"><span id="userName"></span></td>
                                                </tr>
                                                <tr>
                                                    <th>권한</th>
                                                    <td colspan="2"><span id="userClass"></span></td>
                                                </tr>
                                                <tr>
                                                    <th>이메일</th>
                                                    <td colspan="2"><span id="email"></span></td>
                                                </tr>
                                                <tr>
                                                    <th>전화번호</th>
                                                    <td colspan="2"><span id="phone"></span></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <button type="button" id="resetPasswordBtn" class="btn btn--s primary-btn" onclick="resetPasswordBtn()">비밀번호 초기화</button>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <!-- //내용 영역 -->
    </div>
    <!-- //컨텐츠 영역 -->
</div>

<!--모달팝업 영역-->
<div class="layerpopup-wrap layerpopup--l layerpopup--center contact-layer" style="display: none;">
    <div class="layerpopup__header">
        <h1 class="layerpopup__title">고객사 등록</h1>
        <button class="btn icon-btn close-btn" onclick="closeLayerpopup()"><svg class="icon"><use href="/assets/images/icon/sprite-sheet.svg#close"/></svg></button>
    </div>
    <div class="layerpopup__content">
        <div id="company_info">
            <form id="companyForm">
                <table class="table table03 table--h table--xs">
                    <colgroup>
                        <col style="width: 18%;">
                        <col style="width: 32%;">
                        <col style="width: 18%;">
                    </colgroup>
                    <tbody>
                    <tr>
                        <th>회사코드</th>
                        <td colspan="2"><input type="text" id="companyId" class="input--s input01 input--full" name="companyId" placeholder="회사코드를 입력하세요" required /></td>
                    </tr>
                    <tr>
                        <th>회사명</th>
                        <td colspan="2"><input type="text" id="companyName" class="input--s input01 input--full" name="companyName" placeholder="회사명을 입력하세요" required /></td>
                    </tr>
                    <tr>
                        <th>담당자(PM)</th>
                        <td colspan="2"><input type="text" id="managerId" class="input--s input01 input--full" name="managerId" placeholder="담당자명을 입력하세요" required /></td>
                    </tr>
                    </tbody>
                </table>
            </form>
        </div>
    </div>
    <div class="layerpopup__footer">
        <div class="flex flex-justify_center gap--8 btn-wrap">
            <button type="button" class="btn btn--s mono-outline-btn" onclick="closeLayerpopup()">취소</button>
            <button type="button" class="btn btn--s primary-btn" onclick="createCompany()">등록</button>
        </div>
    </div>
</div>
<!--모달팝업 영역-->

<script>
    // -------------------
    // 최초 접속 시(고객사로 고정)
    // ------------------
    $(document).ready(function () {
        $('#companyList').show();        // 고객사 목록 보이기
        $('#companyDetailView').show();  // 고객 상세 보이기
        $('#srch_Company').show();       // 고객사명 검색란 보이
        $("#refresh1").show();           // 새로고침 버튼
    });

    // -------------------
    // clientType(분류값) 설정시
    // 분류 별로 div와, 값이 다르게 표출되는 부분
    // ------------------
    function generateList() {
        var selectedType = $('#clientType').val();
        closeLayerpopup();

        // '고객사 관리' 선택 시 회사 목록을 표시
        if (selectedType === 'COMPANY') {
            $('#companyList').show();
            $('#companyDetailView').show();
            $('#clientList').hide();
            $('#clientDetailView').hide();

            // 클릭 표시 제거 및 상세정보 초기화
            $('#companyList tbody .click-row').removeClass('active');
            $('#companyId').text('');
            $('#companyName').text('');
            $('#managerId').text('');

            // 회사명 검색어 활성화
            $("#srch_Company").show();

            // 고객 검색어 비활성화(고객아이디, 이름, 회사)
            $("#srch_client_id").val('');
            $("#srch_client_nm").val('');
            $("#srch_client_company").val('');
            $("#srchClient_id").hide();
            $("#srchClient_nm").hide();
            $("#srchClient_company").hide();

            $("#refresh1").show();
            $("#refresh2").hide();
        }
        // '고객 관리' 선택 시 고객 목록을 표시
        else if (selectedType === 'CLIENT') {

            searchClient(this);// 샐렉트박스 변경 시 고객 리스트 호출

            $('#clientList').show();
            $('#clientDetailView').show();
            $('#companyList').hide();
            $('#companyDetailView').hide();

            // 클릭 표시 제거 및 상세정보 초기화
            $('#clientList tbody .click-row').removeClass('active');
            $('#userId').text('');
            $('#userName').text('');
            $('#userClass').text('');
            $('#email').text('');
            $('#phone').text('');

            // 회사명 검색어 비활성화
            $("#searchCompany").val('');
            $("#srch_Company").hide();

            // 고객 검색어 활성화(고객아이디, 이름, 회사)
            $("#srchClient_id").show();
            $("#srchClient_nm").show();
            $("#srchClient_company").show();

            $("#refresh2").show();
            $("#refresh1").hide();
        }
    }

    // -------------------
    // 고객사 목록 조회
    // (검색어, 페이징 포함)
    // ------------------
    function searchCompany(obj) {
        if (obj.id == "refresh1"){ $("#searchCompany").val("");}
        var searchCompany = $("#searchCompany").val();
        var page = ($("#currentPage").val() === undefined || $("#currentPage").val() === "") ? '' : $("#currentPage").val();

        $.ajax({
            url: '/companyListData',
            type: 'POST',
            data: {searchCompany: searchCompany, page: page},
            success: function (response) {
                const companyList = response.companyList;

                // 테이블 본문 초기화
                const tableBody = $("#companyBody");
                tableBody.empty();

                if (!companyList || companyList.length === 0) {
                    tableBody.append(`<tr><td colspan="4" style="text-align:center;">내역이 없습니다</td></tr>`);
                } else { // 데이터를 반복하며 테이블에 추가
                    companyList.forEach(function (item) {
                        const row = `
                                        <tr class="click-row" data-id="${item.COMPANY_ID}">
                                            <td><span>${item.COMPANY_ID}</span></td>
                                            <td><span>${item.COMPANY_NAME}</span></td>
                                        </tr>
                                    `;
                        tableBody.append(row);
                    });
                }
                // 페이징 부분 업데이트(서버에서 HTML로 생성된 페이징 버튼 삽입)
                $(".client-footer").html(response.paginationHtml);
                // 이벤트 위임을 통해 callPage 함수가 작동하도록 보장
                $(document).on('click', 'a[data-url][data-page]', function(event) {
                    callPage(event);
                });
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    // ------------------
    // 고객사 상세 조회
    // ------------------
    $(document).on('click', '#companyList .click-row, #companyBody .click-row', function(event) {
        var companyId = $(this).data('id');
        $.ajax({
            url: '/companyDetailData',
            type: 'GET',
            data: {companyId: companyId},
            success: function (response) {
                $('#companyDetailView #companyId').text(response.companyId);     // 회사코드 업데이트
                $('#companyDetailView #companyName').text(response.companyName); // 회사명 업데이트
                $('#companyDetailView #managerId').text(response.managerId);     // 담당자 업데이트
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
                alert('요청 실패: ' + xhr.responseText);
            }
        });
    })

    // -------------------
    // 고객 목록 조회
    // (검색어, 페이징 포함)
    // ------------------
     function searchClient(obj) {
         if (obj.id == "refresh2"){
             $("#srch_client_id").val("");
             $("#srch_client_nm").val("");
             $("#srch_client_company").val("");
         }
         var userId = $("#srch_client_id").val();
         var userName = $("#srch_client_nm").val();
         var searchCompany = $("#srch_client_company").val();
         var page = ($("#currentPage").val() === undefined || $("#currentPage").val() === "") ? '' : $("#currentPage").val();

        $.ajax({
            url: '/clientListData',
            type: 'POST',
            data: {userId: userId, userName:userName, searchCompany: searchCompany, page: page},
            success: function (response) {
                const clientList = response.clientList;

                // 테이블 본문 초기화
                const tableBody = $("#clientBody");
                tableBody.empty();

                if (!clientList || clientList.length === 0) {
                    tableBody.append(`<tr><td colspan="4" style="text-align:center;">내역이 없습니다</td></tr>`);
                } else {
                    clientList.forEach(function (item) {
                        const row = `
                                        <tr class="click-row" th:data-id="${item.userId}">
                                            <td><span>${item.userName}</span></td>
                                            <td><span>${item.companyName}</span></td>
                                            <td><span>${item.userClass}</span></td>
                                        </tr>
                                    `;
                        tableBody.append(row);
                    });
                }
                // 페이징 부분 업데이트(서버에서 HTML로 생성된 페이징 버튼 삽입)
                $(".client-footer2").html(response.paginationHtml);
                // 이벤트 위임을 통해 callPage 함수가 작동하도록 보장
                $(document).off('click', 'a[data-url][data-page]'); // 기존 이벤트 해제(반복호출 제거용)
                $(document).on('click', 'a[data-url][data-page]', function(event) {
                    callPage(event);
                });
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
     }

    // ------------------
    // 고객 상세 조회
    // ------------------
    $(document).ready(function() {
        // 이벤트 위임 방식으로 클릭 이벤트 처리
        $('#clientList').on('click', '.click-row', function () {
            var userId = $(this).attr('th:data-id');

            $.ajax({
                url: '/clientDetailData',
                type: 'GET',
                data: {userId: userId},
                success: function (response) {
                    $('#clientDetailView #userId').text(response.userId);
                    $('#clientDetailView #userName').text(response.userName);
                    $('#clientDetailView #userClass').text(response.userClass);
                    $('#clientDetailView #email').text(response.email);
                    $('#clientDetailView #phone').text(response.phone);
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    alert('요청 실패: ' + xhr.responseText);
                }
            });
        });
    });

    // -------------------
    // 고객사 신규 등록
    // ------------------
    function createCompany() {
        var companyId = $('#companyForm #companyId').val();
        var companyName = $('#companyForm #companyName').val();
        var managerId = $('#companyForm #managerId').val();

        if (!companyId || !companyName || !managerId) {
            alert("모든 필드를 입력해 주세요.");
            return;
        }

        if(confirm("고객사를 등록하시겠습니까?")){
            $.ajax({
                url: '/createCompany',  // 서버의 URL에 맞게 수정
                type: 'POST',
                data: {
                    companyId: companyId,
                    companyName: companyName,
                    managerId: managerId
                },
                success: function(response) {
                    alert('등록 성공!');
                    closeLayerpopup();
                },
                error: function(xhr, status, error) {
                    alert('등록 실패: ' + error);
                }
            });
        }else{
            alert("고객사 등록을 취소하였습니다.");
            closeLayerpopup();
        }
    }

    // -------------------
    // pagination 내 함수 선언
    // ------------------
    function goPage(url, page) {
        $("#currentPage").val(page);
        searchClient(this);
    }

    // -------------------
    // 클릭 시 css 활성화(이벤트 위임을 사용하여 각 li 요소에 active 클래스 추가)
    // ------------------
    $('#companyList').on('click', 'tbody tr', function () {
        $('#companyList tbody .click-row').removeClass('active');
        $(this).addClass('active');
    });
    $('#clientList').on('click', 'tbody tr', function () {
        $('#clientList tbody .click-row').removeClass('active');
        $(this).addClass('active');
    });

    // -------------------
    // 모달 팝업 열기(고객사 등록)
    // ------------------
    function createCompanyModal(){
        $('.layerpopup-wrap').css("display", "block");
        $('.layer-wrap.dimmed').css("display", "block");
    }

    // -------------------
    // 모달 팝업 닫기
    // ------------------
    function closeLayerpopup(){
        $('.layerpopup-wrap').css("display", "none");
        $('.layer-wrap.dimmed').css("display", "none");
    }

    // -------------------
    // 비밀번호 초기화
    // ------------------
    function resetPasswordBtn(){
        let userId = $('#clientDetailView #userId').text().trim();

        if (!userId) { // null, empty 체크
            alert("비밀번호를 초기화할 사용자를 선택해주세요.");
            return; // 함수 종료
        }

        if(confirm("정말 비밀번호를 초기화 하시겠습니까?")){
            const data = new URLSearchParams({
                userId: userId,
            });

            fetch('/resetPassword', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: data.toString()
            })
            .then(response => {
                if (response.ok) {
                    alert("임시 비밀번호가 이메일로 전송되었습니다");
                } else {
                    alert("비밀번호 초기화 요청 중 오류가 발생했습니다.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("요청 처리 중 문제가 발생했습니다.");
            })
        }else{
            alert("비밀번호 초기화를 취소하였습니다.");
        }
    }

</script>
</body>
</html>