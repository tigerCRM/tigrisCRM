<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, maximum-scale=1, width=device-width"/>
    <title>요청 등록 상세</title>
    <link rel="stylesheet" as="style" href="/assets/font/pretendard-subset.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/color.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/common.css?v8">
    <link rel="stylesheet" type="text/css" href="/assets/css/layout.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">
    <script src="/lib/jquery/jquery-2.2.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
    <!--toast ui 설정-->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <!--datepicker 관련 -->
    <script src="/lib/picker/datepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/lib/picker/datepicker.min.css">
    <script src="/js/datepicker.js"></script>
    <!--기타 전역에서 쓸 공통javascript 설정. commit-->
    <script src="/js/common.js"></script>
    <!--메세지-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div class="wrapper">
    <!-- 왼쪽 메뉴  -->
    <div th:replace="~{common/frame_left_menu :: frame_left_menu}"/>
    <!-- 상단 메뉴  -->
    <div th:replace="~{common/frame_top_menu :: frame_top_menu}"/>
    <!-- 컨텐츠 영역 -->
    <div class="main-area">
        <!-- 내용 영역 -->
        <main class="form-content">
            <div class="container">
                <!--왼쪽화면-->
                <div class="main-widget-wrap">
                    <div class="content">
                        <!-- 헤더 영역 -->
                        <div class="search--box">
                            <div class="content-header">
                                <h2 class="text-body1">
                                    <div class="flex flex-align_center gap--8">
                                        <b>요청 정보 상세</b>
                                    </div>
                                </h2>
                            </div>
                        </div>
                        <!-- //헤더 영역 -->
                        <!-- form 영역 -->
                        <form action="/ticketModify" method="post" enctype="multipart/form-data"
                              th:object="${ticketinfo}">
                            <div>
                                <!--사용자 입력 영역-->
                                <table class="table table03 table--h table--xs">
                                    <colgroup>
                                        <col style="width: 18%;">
                                        <col style="width: auto;">
                                        <col style="width: 18%;">
                                        <col style="width: auto;">
                                    </colgroup>
                                    <tbody>
                                    <tr>
                                        <input type="hidden" id="ticketId" th:field="*{ticketId}">
                                        <!--진행사항 progress bar-->
                                        <div class="step-progress">
                                            <div class="step">
                                                <div class="step-number">1</div>
                                                <div class="step-status">OPEN</div>
                                                <div class="step-label">등록</div>
                                            </div>
                                            <div class="separator"></div>
                                            <div class="step">
                                                <div class="step-number">2</div>
                                                <div class="step-status">RECEIPT</div>
                                                <div class="step-label">접수</div>
                                            </div>
                                            <div class="separator"></div>
                                            <div class="step">
                                                <div class="step-number">3</div>
                                                <div class="step-status">PROGRESS</div>
                                                <div class="step-label">진행</div>
                                            </div>
                                            <div class="separator"></div>
                                            <div class="step">
                                                <div class="step-number">4</div>
                                                <div class="step-status">REVIEW</div>
                                                <div class="step-label">검토</div>
                                            </div>
                                            <div class="separator"></div>
                                            <div class="step">
                                                <div class="step-number">5</div>
                                                <div class="step-status">CLOSED</div>
                                                <div class="step-label">완료</div>
                                            </div>
                                        </div>
                                    </tr>
                                    <tr>
                                        <th>제목</th>
                                        <td colspan="3">
                                            <span id="title" th:text="*{title}"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>요청자</th>
                                        <td>
                                            <span id="createName" th:text="*{createName}"></span>
                                        </td>
                                        <th>고객사</th>
                                        <td>
                                            <span id="companyName" th:text="*{companyName}"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>담당자</th>
                                        <td>
                                            <span id="managerName" th:text="*{managerName}"></span>
                                            <input type="hidden" id="managerId" th:field="*{managerId}">
                                        </td>
                                        <th>중요도</th>
                                        <td>
                                            <span th:switch="*{priorityYn}">
                                                <span th:case="'Y'">긴급</span>
                                                <span th:case="'N'">일반</span>
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>작업구분</th>
                                        <td>
                                            <span th:switch="*{requestTypeCd}">
                                                <span th:case="'QA'">문의답변</span>
                                                <span th:case="'ERR'">오류수정</span>
                                                <span th:case="'ADD'">기능추가</span>
                                                <span th:case="'CH'">기능변경</span>
                                                <span th:case="'SP'">기술지원</span>
                                                <span th:case="'ETC'">기타</span>
                                            </span>
                                        </td>
                                        <th>지원범위</th>
                                        <td>
                                            <span th:switch="*{supportCd}">
                                                <span th:case="'ST'">기본</span>
                                                <span th:case="'ADD'">추가</span>
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>희망완료일</th>
                                        <td>
                                            <span id="expectedCompleteDt" name="expectedCompleteDt" th:text="*{expectedCompleteDt}"></span>
                                        </td>
                                        <th>진행상태</th>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 5px;">
                                                <div class="dropdown dropdown--s wd130" aria-expanded="false"
                                                     tabindex="0">
                                                    <select class="dropdown__selected" id="statusCd" name="statusCd"
                                                            th:field="*{statusCd}" th:disabled="${userClass == 'USER'}">
                                                        <option th:each="op : ${statusCd}"
                                                                th:value="${op.key}"
                                                                th:text="${op.value}"></option>
                                                    </select>

                                                </div>
                                                <div>
                                                    <button type="button" class="btn btn--s primary-btn"
                                                            onclick="changeStatus()">상태저장
                                                    </button>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>작업완료일</th>
                                        <td>
                                            <span id="completeDt" th:text="*{completeDt}"></span>
                                        </td>
                                        <th>처리일수</th>
                                        <td>
                                            <span id="md" th:text="*{md}"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="4">
                                            <div class="editor-wrap">
                                                <div class="editor-wrap">
                                                    <div id="editorContent"></div>
                                                    <input type="hidden" name="content" id="content"
                                                           th:field="*{content}">
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr th:if="${uploadFiles != null and not uploadFiles.isEmpty()}">
                                        <th>첨부파일</th>
                                        <td colspan="3">
                                            <div class="attachment-wrapper">
                                                <div class="attachment-file">
                                                    <!--기존에 있었던 첨부파일-->
                                                    <ul id="fileAttach" class="list01">
                                                        <li class="list__item" th:each="file : ${uploadFiles}">
                                                            <div class="item__title">
                                                                <svg class="icon icon--20 color-gray700">
                                                                    <use href="/assets/images/icon/sprite-sheet.svg#attachment"></use>
                                                                </svg>
                                                                <a th:href="@{/fileDownload(fileName=${file.fileName})}"
                                                                   th:text="${file.originFileName}"
                                                                   class="file-link">파일 이름 sample</a>
                                                            </div>
                                                        </li>
                                                    </ul>
                                                    <!--//기존에 있었던 첨부파일-->
                                                    <!--추가하는 첨부파일-->
                                                    <ul id="addfileAttach" class="list01">
                                                    </ul>
                                                    <!--//추가하는 첨부파일-->
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                                <!--//사용자 입력 영역-->
                                <!--댓글 영역-->
                                <!--의견 영역-->
                                <div class="comment__write" th:style="${commentList == null or commentList.size() == 0 ? 'display:none;' : ''}">
                                    <div>
                                        <h2>피드백</h2>
                                    </div>
                                    <div th:if="${commentList != null and commentList.size() > 0}">
                                        <div class="message_box" th:each="comment : ${commentList}">
                                            <div class="message_info">
                                                <div class="user_name" th:text="${comment.createName}">작성자</div>
                                                <div th:class="${comment.userClass == 'USER' ? 'message' : 'sendmessage'}">
                                                    <p style="display:inline-block; white-space: pre-wrap;" th:text="${comment.content}"></p>
                                                </div>
                                                <div class="message_time">
                                                    <span th:text="${comment.createDt}"></span>
                                                    <button type="button" class="btn btn--xs mono-ghost-btn" onclick="delComment(this)"
                                                            th:if="${user.userName == comment.createName}"
                                                            th:attr="data-comment-id=${comment.answerId}">삭제</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="comment__write" >
                                    <textarea id="comment" cols="30" rows="10" class="textarea01 input--full"
                                              placeholder="댓글을 입력해주세요"></textarea>
                                    <div class="flex flex-justify_end mt8">
                                        <svg class="icon icon--20 color-gray700" style="margin-right: 10px;margin-top: 8px;cursor:pointer" onclick="addAttachComment();">
                                            <use href="/assets/images/icon/sprite-sheet.svg#attachment"></use>
                                        </svg>
                                        <button type="button" class="btn btn--s primary-btn" onclick="addComment()">댓글 작성</button>
                                    </div>
                                </div>
                                <!--//댓글 영역-->
                                <!--버튼그룹-->
                                <div class="button-group align-right">
                                    <button type="submit" class="btn btn--m primary-btn">수정</button>
                                    <button type="button" class="btn btn--m danger-btn" onclick="deleteTicket()">삭제</button>
                                    <button type="button" class="btn btn--m secondary-btn"
                                            onclick="location.href='/ticketList';">목록으로
                                    </button>
                                </div>
                                <!--//버튼그룹-->
                            </div>
                        </form>
                        <!-- //form 영역 -->
                    </div>
                </div>
                <!--오른쪽화면-->
                <div class="main-widget-wrap">

                </div>
            </div>
        </main>
        <!-- //내용 영역 -->
    </div>
    <!-- //컨텐츠 영역 -->
</div>

<script>
    var mode = "read";
    var editor = common.loadOrInitializeEditor(editor , mode);

    //상태 progress
    document.addEventListener("DOMContentLoaded", function () {
       const stepProgress = document.querySelector('.step-progress');
       const statusCd = $("#statusCd").val();

       const steps = stepProgress.querySelectorAll('.step');
       const statusOrder = ['OPEN', 'RECEIPT', 'PROGRESS', 'REVIEW', 'CLOSED'];

       steps.forEach((step, index) => {
           const stepStatus = step.querySelector('.step-status').textContent;

           if (statusOrder.indexOf(stepStatus) < statusOrder.indexOf(statusCd)) {
               step.classList.add('completed');
               step.classList.remove('active');
           } else if (statusOrder.indexOf(stepStatus) === statusOrder.indexOf(statusCd)) {
               step.classList.add('active');
              step.classList.remove('completed');
           } else {
               step.classList.remove('active', 'completed');
           }
       });
    });

    //상태변경
    function changeStatus() {
        const url = `/changeStatus`;
        var id = $("#ticketId").val();
        var newStatus = $("#statusCd").val();
        const requestData = { status: newStatus,id : id};

        // 비동기 요청 (POST 방식)
        fetch(url, {
            method: 'PUT',
            headers: {
            'Content-Type': 'application/json',
        },
            body: JSON.stringify(requestData),
        })
        .then(response => {
            if (!response.ok) {
            return response.text().then(text => { throw new Error(text); });
        }
        return response.json();
        })
        .then(data => {
            console.log('Status updated successfully:', data);
            showMessage('success', '성공', '진행상태가 변경되었습니다.');
           // location.reload();
        })
        .catch(error => {
            console.error('Error updating status:', error);
            showMessage('error', '실패', '상태 업데이트 중 오류가 발생했습니다:');
        });
    }

    // 댓글 작성
    function addComment() {
        const comment = document.getElementById("comment").value;
        var id = $("#ticketId").val();
        var statusCd = $("#statusCd").val();
        if (!comment) {
            showMessage('info', '정보', '댓글 내용을 입력하세요.');
            return;
        }

        $.ajax({
            url: '/comments', // 서버 컨트롤러 URL
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                comment: comment,
                ticketId: id,
                statusCd: statusCd
            }),
            success: function(response) {
                location.reload();
            },
            error: function(error) {
                alert("댓글 등록 중 오류가 발생했습니다.");
            }
        });
    }

    //수정
    function goModify(){
        var id = $("#ticketId").val();
        window.location.href = '/ticketCreate/'+id;
    }

    //삭제
    function deleteTicket(){
        if (showConfirm("question","삭제하시겠습니까?","")) {}
    }

    //확인창에서 호출하는 함수
    function afterConfirm(){
        var id = $("#ticketId").val();
        var url = `/deleteTicket`;
        fetch(url, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ Id: id }),
        })
        .then(response => {
            if (response.ok) {
                showMessage('success', '삭제', '해당 티켓 정보가 삭제되었습니다.');
            } else {
                response.text().then(message => {
                    showMessage('error', '서버응답실패', '서버에서 오류가 발생하였습니다.');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('error', '실패', '오류가 발생해 서버로 요청을 전송하지 못했습니다');
        });
    }

    function delComment(obj){
        var id = obj.getAttribute('data-comment-id');
        console.log("댓글 삭제: ", id);
        var url = `/deleteCommentId`;
        fetch(url, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ Id: id }),
        })
        .then(response => {
            if (response.ok) {
                showMessage('success', '댓글삭제', '해당 댓글이 삭제되었습니다.');
            } else {
                response.text().then(message => {
                    showMessage('error', '서버응답실패', '서버에서 오류가 발생하였습니다.');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('error', '실패', '오류가 발생해 서버로 요청을 전송하지 못했습니다');
        });
    }

    //댓글 첨부파일추가
    function addAttachComment(){
        alert("아직 고민중");
    }
</script>
</body>
</html>
