<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, maximum-scale=1, width=device-width"/>
    <title>요청 등록 상세</title>
    <link rel="stylesheet" as="style" href="/assets/font/pretendard-subset.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/color.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/common.css?v8">
    <link rel="stylesheet" type="text/css" href="/assets/css/layout.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">
    <script src="/lib/jquery/jquery-2.2.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
    <!--toast ui 설정-->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <!--datepicker 관련 -->
    <script src="/lib/picker/datepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/lib/picker/datepicker.min.css">
    <script src="/js/datepicker.js"></script>
    <!--기타 전역에서 쓸 공통javascript 설정. commit-->
    <script src="/js/common.js"></script>
</head>
<body>
<div class="wrapper">
    <!-- 왼쪽 메뉴  -->
    <div th:replace="~{common/frame_left_menu :: frame_left_menu}"/>
    <!-- 상단 메뉴  -->
    <div th:replace="~{common/frame_top_menu :: frame_top_menu}"/>
    <!-- 컨텐츠 영역 -->
    <div class="main-area">
        <!-- 내용 영역 -->
        <main class="form-content">
            <div class="container">
                <!--왼쪽화면-->
                <div class="main-widget-wrap">
                    <div class="content">
                        <!-- 헤더 영역 -->
                        <div class="search--box">
                            <div class="content-header">
                                <h2 class="text-body1">
                                    <div class="flex flex-align_center gap--8">
                                        <b>요청 등록 상세</b>
                                    </div>
                                </h2>
                            </div>
                        </div>
                        <!-- //헤더 영역 -->
                        <!-- form 영역 -->
                        <form action="/ticketCreate" method="post" enctype="multipart/form-data"
                              th:object="${ticketinfo}">
                            <div>
                                <!--사용자 입력 영역-->
                                <table class="table table03 table--h table--xs">
                                    <colgroup>
                                        <col style="width: 18%;">
                                        <col style="width: auto;">
                                        <col style="width: 18%;">
                                        <col style="width: auto;">
                                    </colgroup>
                                    <tbody>
                                    <tr>
                                        <input type="hidden" id="ticketId" th:field="*{ticketId}">
                                        <input type="hidden" id="statusCd" th:field="*{statusCd}">
                                        <!--진행사항 progress bar-->
                                        <div class="step-progress">
                                            <div class="step">
                                                <div class="step-number" onclick="changeStatus('OPEN')">1</div>
                                                <div class="step-status">OPEN</div>
                                                <div class="step-label">등록</div>
                                            </div>
                                            <div class="separator"></div>
                                            <div class="step">
                                                <div class="step-number" onclick="changeStatus('RECEIPT')">2</div>
                                                <div class="step-status">RECEIPT</div>
                                                <div class="step-label">접수</div>
                                            </div>
                                            <div class="separator"></div>
                                            <div class="step">
                                                <div class="step-number" onclick="changeStatus('PROGRESS')">3</div>
                                                <div class="step-status">PROGRESS</div>
                                                <div class="step-label">진행</div>
                                            </div>
                                            <div class="separator"></div>
                                            <div class="step">
                                                <div class="step-number" onclick="changeStatus('REVIEW')">4</div>
                                                <div class="step-status">REVIEW</div>
                                                <div class="step-label">검토</div>
                                            </div>
                                            <div class="separator"></div>
                                            <div class="step">
                                                <div class="step-number" onclick="changeStatus('CLOSED')">5</div>
                                                <div class="step-status">CLOSED</div>
                                                <div class="step-label">완료</div>
                                            </div>
                                        </div>
                                    </tr>
                                    <tr>
                                        <th>제목</th>
                                        <td colspan="3">
                                            <span id="title" th:text="*{title}"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>요청자</th>
                                        <td>
                                            <span id="createName" th:text="*{createName}"></span>
                                        </td>
                                        <th>고객사</th>
                                        <td>
                                            <span id="companyName" th:text="*{companyName}"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>담당자(PM)</th>
                                        <td colspan="3">
                                            <span id="managerName" th:text="*{managerName}"></span>
                                            <input type="hidden" id="managerId" th:field="*{managerId}">
                                        </td>

                                    </tr>
                                    <tr>
                                        <th>작업구분</th>
                                        <td>
                                            <span th:switch="*{requestTypeCd}">
                                                <span th:case="'QA'">문의답변</span>
                                                <span th:case="'ERR'">오류수정</span>
                                                <span th:case="'ADD'">기능추가</span>
                                                <span th:case="'CH'">기능변경</span>
                                                <span th:case="'SP'">기술지원</span>
                                                <span th:case="'ETC'">기타</span>
                                            </span>
                                        </td>
                                        <th>지원범위</th>
                                        <td>
                                            <span th:switch="*{supportCd}">
                                                <span th:case="'ST'">기본</span>
                                                <span th:case="'ADD'">추가</span>
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>중요도</th>
                                        <td>
                                            <span th:switch="*{priorityYn}">
                                                <span th:case="'Y'">긴급</span>
                                                <span th:case="'N'">일반</span>
                                            </span>
                                        </td>
                                        <th>희망완료일</th>
                                        <td>
                                            <span id="expectedCompleteDt" th:text="*{expectedCompleteDt}"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>작업완료일</th>
                                        <td>
                                            <span id="completeDt" th:text="*{completeDt}"></span>
                                        </td>
                                        <th>처리일수</th>
                                        <td>
                                            <span id="md" th:text="*{md}"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="4">
                                            <div class="editor-wrap">
                                                <div class="editor-wrap">
                                                    <div id="editorContent"></div>
                                                    <input type="hidden" name="content" id="content" th:field="*{content}">
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>첨부파일</th>
                                        <td colspan="3">
                                            <div class="attachment-wrapper">

                                                <div class="attachment-file">
                                                    <ul class="list01">
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                                <!--//사용자 입력 영역-->
                                <!--댓글 영역-->
                                <!--의견 영역-->
                                <div class="comment__write">
                                    <div>
                                        <h2>코멘트</h2>
                                    </div>
                                    <div class="message_box" >
                                        <div class="message_info">
                                            <div class="user_name">남루니</div>

                                            <div class="message">
                                                <p style="display:inline-block;">이것도 안되고 저것도 안되고 다안됩니다.</p>
                                            </div>
                                            <div class="message_time">24/12/04 07:52</div>
                                        </div>
                                    </div>
                                    <div class="message_box" >
                                        <div class="message_info">
                                            <div class="user_name">담당자</div>
                                            <div class="sendmessage">
                                                <p style="display:inline-block;">이거랑 저거랑 요거랑 저거 수정했으니 확인 부탁드립니다.</p>
                                            </div>
                                            <div class="message_time">24/12/04 07:52</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="comment__write">
                                    <!-- (확인) 댓글 입력 전에는 댓글 작성 버튼 비활성화 -->
                                    <textarea name="" id="" cols="30" rows="10" class="textarea01 input--full" placeholder="댓글을 입력해주세요"></textarea>
                                    <div class="flex flex-justify_end mt8">
                                        <button type="button" class="btn btn--s primary-btn">댓글 작성</button>
                                    </div>
                                </div>
                                <!--//댓글 영역-->
                                <!--버튼그룹-->
                                <div class="button-group align-right">
                                    <button type="submit" class="btn btn--m  primary-btn">글수정</button>
                                    <button type="button" class="btn btn--m  secondary-btn"
                                            onclick="location.href='/ticketList';">목록으로
                                    </button>
                                </div>
                                <!--//버튼그룹-->
                            </div>
                        </form>
                        <!-- //form 영역 -->
                    </div>
                </div>
                <!--오른쪽화면-->
                <div class="main-widget-wrap">

                </div>
            </div>
        </main>
        <!-- //내용 영역 -->
    </div>
    <!-- //컨텐츠 영역 -->
</div>

<script>
    var mode = "read";
    var editor = common.loadOrInitializeEditor(editor , mode);


    document.addEventListener("DOMContentLoaded", function () {
       const stepProgress = document.querySelector('.step-progress');
       const statusCd = $("#statusCd").val();

       const steps = stepProgress.querySelectorAll('.step');
       const statusOrder = ['OPEN', 'RECEIPT', 'PROGRESS', 'REVIEW', 'CLOSED'];

       steps.forEach((step, index) => {
           const stepStatus = step.querySelector('.step-status').textContent;

           if (statusOrder.indexOf(stepStatus) < statusOrder.indexOf(statusCd)) {
               step.classList.add('completed');
               step.classList.remove('active');
           } else if (statusOrder.indexOf(stepStatus) === statusOrder.indexOf(statusCd)) {
               step.classList.add('active');
              step.classList.remove('completed');
           } else {
               step.classList.remove('active', 'completed');
           }
       });
    });

    function changeStatus(newStatus) {
      // 요청 보낼 URL 설정
      const url = `/changeStatus`;
      var id = $("#ticketId").val();
      // 서버로 보낼 데이터 준비
      const requestData = { status: newStatus,id : id};

      // 비동기 요청 (POST 방식)
      fetch(url, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData), // 데이터를 JSON 형식으로 변환
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => { throw new Error(text); }); // 서버에서 반환한 메시지를 추출하여 에러 처리
        }
        return response.json(); // 서버에서 반환된 데이터를 JSON으로 변환
      })
          .then(data => {
            console.log('Status updated successfully:', data);
            // 성공 시 상태 업데이트 로직 추가 (UI 갱신 등)
            alert('요청 등록 상태가 변경되었습니다.');
            // 예: 페이지 리로드 또는 특정 UI 요소 업데이트
            // location.reload(); // 페이지 새로고침 (필요한 경우)
          })
          .catch(error => {
            console.error('Error updating status:', error);
            alert('상태 업데이트 중 오류가 발생했습니다: ' + error.message);
          });
    }

</script>
</body>
</html>
